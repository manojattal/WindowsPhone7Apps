(function(m,h){var e={};var o=0;var a=null;var n=0;var q=0;var b=0;var c=null;var k=null;var d=null;var j=null;var i=null;var l=null;var f=false;var p=true;var g=[];m.stationselector=function(r){e=h.extend({lat:0,lon:0,zoom:10,draggable:true,selector:null,mapSelector:null,showhideSelector:null,showhideSecondarySelector:null,rowPWSSelector:null,rowAirportSelector:null,conditionsSelector:null,forecastSelector:null,numstartSelector:null,numendSelector:null,numtotalSelector:null,nextSelector:null,prevSelector:null,timelabelSelector:null,webcampreviewSelector:null,webcamiconSelector:null,webcamShowDelay:500,webcamHideDelay:100,condsboxurl:null,zmw_key:null,max:100,fitBounds:false,markerPWSClass:"",markerAirportClass:"",selectedClass:"selected",hoverClass:"hover",expandedClass:"expanded",disabledClass:"disabled",renumbering:true},r?r:{});var s=[];if(e.showhideSelector){s.push(e.showhideSelector)}if(e.showhideSecondarySelector){s.push(e.showhideSecondarySelector)}var t=h(s.join(","));t.live("click",function(u){var v=h(e.selector).is(":visible");if(v){m.stationselector.hide()}else{m.stationselector.show()}})};m.stationselector.show=function(){h(e.selector).show().removeClass("none");h(e.selector).position({my:"right top",at:"right bottom",of:e.showhideSelector,collision:"none none",offset:"14 12"});h(e.showhideSelector).addClass(e.expandedClass);m.stationselector.load()};m.stationselector.hide=function(){h(e.selector).hide().addClass("none");h(e.showhideSelector).removeClass(e.expandedClass);m.stationselector.webcam.hide()};m.stationselector.load=function(){if(o!=1){var s="wui.stationselector.initialize";var r="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false";if(s){r+="&callback="+s}h.getScript(r,function(t,u){o=1})}};m.stationselector.initialize=function(){var s={center:new google.maps.LatLng(e.lat,e.lon),draggable:e.draggable,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:false,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},navigationControl:true,scaleControl:false,scrollwheel:false,streetViewControl:false,zoom:e.zoom};var r=h(e.mapSelector);a=new google.maps.Map(r[0],s);m.stationselector.defineClasses();i=h(e.rowAirportSelector);l=h(e.rowPWSSelector);i.each(function(t,u){m.stationselector.setupMarker(t,u,true)});l.each(function(t,u){m.stationselector.setupMarker(t,u,false)});google.maps.event.addListenerOnce(a,"tilesloaded",function(){for(var t=g.length-1;t>=0;t--){g[t].marker.setMap(a)}});q=l.length;b=q;m.stationselector.setVisibilites();h(e.nextSelector).click(function(t){m.stationselector.next();return false});h(e.prevSelector).click(function(t){m.stationselector.prev();return false});h(e.webcampreviewSelector).bind({mouseenter:function(){window.clearTimeout(j)},mouseleave:function(){j=window.setTimeout(function(){m.stationselector.webcam.hide()},e.webcamHideDelay)}});google.maps.event.addListener(a,"idle",m.stationselector.mapChanged)};m.stationselector.setupMarker=function(v,C,y){C=h(C);var z=parseFloat(C.attr("data-lat"))||0;var r=parseFloat(C.attr("data-lon"))||0;var A=C.attr("title");var B=new google.maps.LatLng(z,r);var x=(v+1);var w=(y)?"":x;var t=y||(v>=n&&v<n+e.max);var u=new m.stationselector.HTMLOverlay({content:w,clickable:true,position:B,visible:t,title:A});if(y){u.addClass(e.markerAirportClass)}else{u.addClass(e.markerPWSClass)}if(C.hasClass(e.selectedClass)){c=C;k=u;u.addClass(e.selectedClass)}C.bind({mouseenter:function(){C.addClass(e.hoverClass);u.addClass(e.hoverClass)},mouseleave:function(){C.removeClass(e.hoverClass);u.removeClass(e.hoverClass)},click:function(){m.stationselector.select(C,u)}});if(!t){C.addClass("none")}google.maps.event.addListener(u,"mouseover",function(){C.mouseenter()});google.maps.event.addListener(u,"mouseout",function(){C.mouseout()});google.maps.event.addListener(u,"click",function(){C.click()});g.push({row:C,marker:u,alwaysVisible:y,originalIndex:v,distance:0,in_bounds:false});var s=C.find(e.webcamiconSelector);s.bind({mouseenter:function(){s.addClass(e.hoverClass);d=window.setTimeout(function(){s.click()},e.webcamShowDelay)},mouseleave:function(){s.removeClass(e.hoverClass);window.clearTimeout(d);j=window.setTimeout(function(){m.stationselector.webcam.hide()},e.webcamHideDelay)},click:function(){return false}})};m.stationselector.select=function(u,r){if(!e.zmw_key){return}if(!u[0]){return}var v=u.attr("data-id");var t=new Date().getTime();m.stationselector.hide();var s="/auto/wui/geo/PrefDump/index.html?setprefs.0.key="+e.zmw_key+"&setprefs.0.val="+v;s+="&rand="+t;h.ajax({url:s,success:function(w,x){if(e.condsboxurl){h(e.conditionsSelector).fadeOut("slow");h.ajax({url:e.condsboxurl,dataType:"html",data:{rand:t,responder:"1",request:"conditions"},success:function(y,z){h(e.conditionsSelector).html(y);h(e.conditionsSelector).fadeIn("slow",function(){h(e.conditionsSelector).children().eq(0).unwrap()});h(e.forecastSelector).fadeOut("slow");h(e.timelabelSelector).html(h(e.timelabelSelector+"_hidden").html());h.ajax({url:e.condsboxurl,dataType:"html",data:{rand:t,responder:"1",request:"forecast"},success:function(A,B){h(e.forecastSelector).html(A);h(e.forecastSelector).fadeIn("slow",function(){})}})}})}c.removeClass(e.selectedClass);k.removeClass(e.selectedClass);u.addClass(e.selectedClass);r.addClass(e.selectedClass);c=u;k=r}})};m.stationselector.setVisibilites=function(){var v=0;var E=0;var r=a.getBounds();var C=new google.maps.LatLngBounds();var D=i.length;if(D>0&&n==0){C.extend(g[0].marker.getPosition())}for(var y=0;y<g.length;y++){var B=g[y];if(B.alwaysVisible){continue}var F=B.row;var u=B.marker;var A=u.getPosition();if(f){var s=B.in_bounds;var t=(s&&v>=n&&E<n+e.max);if(s){E++}}else{var t=(v>=n&&v<n+e.max)}if(t){F.removeClass("none");u.setVisible(true);C.extend(A)}else{F.addClass("none");u.setVisible(false)}v++}if(e.fitBounds&&!f&&!C.isEmpty()){var x=new google.maps.LatLng(e.lat,e.lon);C.extend(x);a.fitBounds(C)}var z=q;var w=n+e.max;if(w>z){w=z}m.stationselector.updateCounters(n,w,z);if(f&&p){p=false}};m.stationselector.updateCounters=function(t,r,s){h(e.numstartSelector).html(t+1);h(e.numendSelector).html(r);h(e.numtotalSelector).html(s);if(t==0){h(e.prevSelector).addClass(e.disabledClass)}else{h(e.prevSelector).removeClass(e.disabledClass)}if(r>=s){h(e.nextSelector).addClass(e.disabledClass)}else{h(e.nextSelector).removeClass(e.disabledClass)}};m.stationselector.mapChanged=function(){if(h(a.getDiv()).width()<1||h(a.getDiv()).height()<1){p=true;return}if(p){p=false;return}f=true;var D=0;var r=a.getBounds();var s=a.getCenter();var C=i.length;var v=null;for(var y=0;y<g.length;y++){var B=g[y];var w=B.marker;var A=w.getPosition();B.in_bounds=(r.contains(A));if(B.in_bounds){B.distance=google.maps.geometry.spherical.computeDistanceBetween(s,A)}else{B.distance=Infinity}}g.sort(function(G,F){return G.distance-F.distance});for(var y=0;y<g.length;y++){var B=g[y];if(B.alwaysVisible){continue}var w=B.marker;var E=B.row;var A=w.getPosition();var t=B.in_bounds;var u=(t&&D<e.max);if(u){E.removeClass("none");w.setVisible(true);B.visible=true}else{E.addClass("none");w.setVisible(false);B.visible=false}if(t){D++;if(e.renumbering){w.setContent(D);E.find("span").eq(0).html(D);if(v){E.insertAfter(v)}v=E}}}n=0;q=D;var z=q;var x=n+e.max;if(x>z){x=z}m.stationselector.updateCounters(n,x,z)};m.stationselector.next=function(){if(n+e.max<q){n+=e.max;p=true;m.stationselector.setVisibilites()}};m.stationselector.prev=function(){if(n-e.max>=0){n-=e.max;p=true;m.stationselector.setVisibilites()}};m.stationselector.reset=function(){};m.stationselector.webcam=function(v,t){var w=h(e.webcampreviewSelector);var r=w.find("a");var s=w.find("img");var u=s.attr("src");r.attr("href",h(v).attr("href"));s.attr("src",t);w.removeClass("none");w.position({my:"center bottom",at:"center top",of:h(v)});if(u==t){m.stationselector.webcam.hide()}};m.stationselector.webcam.hide=function(){var s=h(e.webcampreviewSelector);var r=s.find("img");s.addClass("none");r.attr("src","")};m.stationselector.defineClasses=function(){m.stationselector.HTMLOverlay=function(r){this.options_=h.extend({position:null,content:null,map:null,mouseable:true,visible:true,title:"",pane:"mapPane",align:"center",valign:"center",offset:null},r?r:{});this.map_=this.options_.map;this.container_=h("<div></div>");this.mouseTarget_=null;this.width_=0;this.height_=0;this.setMap(this.map_)};m.stationselector.HTMLOverlay.prototype=new google.maps.OverlayView();m.stationselector.HTMLOverlay.prototype.onAdd=function(){this.container_.css({position:"absolute"});this.setContent(this.options_.content);var t=this.map_;var s=this.getPanes();if(this.options_.mouseable){s.overlayImage.appendChild(this.container_[0])}else{s[this.options_.pane].appendChild(this.container_[0])}this.width_=this.container_.width();this.height_=this.container_.height();if(this.options_.mouseable){this.mouseTarget_=h("<div></div>").css({position:"absolute",width:this.width_,height:this.height_,cursor:"pointer"});if(this.options_.title.length>0){this.mouseTarget_.attr("title",this.options_.title)}s.overlayMouseTarget.appendChild(this.mouseTarget_[0]);var r=this;this.mouseTarget_.bind({click:function(){google.maps.event.trigger(r,"click")},mouseenter:function(){google.maps.event.trigger(r,"mouseover")},mouseleave:function(){google.maps.event.trigger(r,"mouseout")}})}this.setVisible(this.options_.visible)};m.stationselector.HTMLOverlay.prototype.onRemove=function(){if(this.mouseTarget_){this.mouseTarget_.remove()}this.container_.remove()};m.stationselector.HTMLOverlay.prototype.draw=function(){var r=this.getProjection();var u=r.fromLatLngToDivPixel(this.options_.position);var t=u.x;var s=u.y;if(this.options_.align=="center"){t-=(this.width_/2)}else{if(this.options_.align=="right"){t-=(this.width_)}}if(this.options_.valign=="center"){s-=(this.height_/2)}else{if(this.options_.valign=="bottom"){s-=(this.height_)}}if(this.options_.offset){t+=this.options_.offset.x;s+=this.options_.offset.y}this.container_.css({left:t,top:s});if(this.mouseTarget_){this.mouseTarget_.css({left:t,top:s})}};m.stationselector.HTMLOverlay.prototype.setVisible=function(r){if(r){this.container_.show();if(this.mouseTarget_){this.mouseTarget_.show()}}else{this.container_.hide();if(this.mouseTarget_){this.mouseTarget_.hide()}}};m.stationselector.HTMLOverlay.prototype.setContent=function(r){this.container_.html(r)};m.stationselector.HTMLOverlay.prototype.getPosition=function(){return this.options_.position};m.stationselector.HTMLOverlay.prototype.addClass=function(r){this.container_.addClass(r)};m.stationselector.HTMLOverlay.prototype.removeClass=function(r){this.container_.removeClass(r)};m.stationselector.HTMLOverlay.prototype.toggleClass=function(r){this.container_.toggleClass(r)}}})(wui,jQuery);